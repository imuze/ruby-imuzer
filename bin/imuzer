#!/usr/bin/env ruby

require 'optparse'
require 'methadone'
require 'imuzer.rb'

class App
  include Methadone::Main
  include Methadone::CLILogging

  main do |email, password, duration, genre, subgenre, structure|
    info 'Authenticating to iMuze ....'
    response = Imuze::CreateToken.call(email, password)
    token = response['token']
    info "Composing your #{subgenre} #{genre} on iMuze ...."
    start = Time.now
    response = Imuze::CreateMusic.call(token, duration,
                                       genre, subgenre, structure)
    elapsed = Time.now - start
    info "Done composing your music in #{elapsed} seconds"
    mp3_uri = response['mp3_uri']
    info "Playing your #{subgenre} #{genre} music ...."
    Imuze::GetMusic.call(token, mp3_uri)
  end

  version Imuzer::VERSION
  description 'Composes a track with iMuze'
  arg :email, 'Account email'
  arg :password, 'Account password'
  arg :duration, 'Track duration'
  arg :genre, 'Track genre'
  arg :subgenre, 'Track subgenre'
  arg :structure, 'Track structure'
  use_log_level_option toggle_debug_on_signal: 'USR1'
  go!
end
